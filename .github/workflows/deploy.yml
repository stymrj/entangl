name: Deploy Static Website to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      SSH_USER: ${{ secrets.EC2_USER }}
      SERVER_IP: ${{ secrets.EC2_HOST }}
      TARGET_PATH: "/var/www/html/entangl.in"

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install dependencies
      - name: Install dependencies
        run: npm install

      # 3️⃣ Build the project
      - name: Build project
        run: npm run build

      # 4️⃣ Debug dist folder (optional)
      - name: Debug dist folder
        run: |
          echo "Dist contents:"
          ls -la dist

      # 5️⃣ Prepare SSH key
      - name: Prepare SSH key
        run: |
          echo "$SSH_PRIVATE_KEY" > key.pem
          chmod 600 key.pem
          ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

      # 6️⃣ Clear old files on EC2
      - name: Clear old files on EC2
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP "rm -rf $TARGET_PATH/*"

      # 7️⃣ Copy dist contents to EC2
      - name: Copy dist contents to EC2
        run: |
          scp -i key.pem -o StrictHostKeyChecking=no -r dist/* $SSH_USER@$SERVER_IP:$TARGET_PATH/
